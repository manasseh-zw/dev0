// dev0 Database Schema
// PostgreSQL on Neon

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Enums
// ============================================

enum ProjectStatus {
  PLANNING    // AI is generating the plan
  READY       // Plan approved, ready to start
  ACTIVE      // Tasks are being executed
  PAUSED      // Execution paused by user
  COMPLETED   // All tasks done
  ARCHIVED    // Project archived
}

enum TaskStatus {
  PENDING     // Waiting for dependencies
  RUNNING     // Currently executing in sandbox
  REVIEW      // PR created, awaiting merge
  DONE        // PR merged, task complete
  FAILED      // Execution failed
  SKIPPED     // Manually skipped by user
}

enum SandboxStatus {
  READY       // Sandbox is provisioned and ready
  RUNNING     // Task is executing
  STOPPED     // Sandbox stopped
}

// ============================================
// Models
// ============================================

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)

  // GitHub Repository
  repoUrl     String?
  repoName    String?       // e.g., "dev0-agent/project-x9k"

  // Configuration
  techStack   String        @default("tanstack-start") // tanstack-start, nextjs, vite
  theme       String        @default("slate")          // TweakCN theme

  // The original "vibe" input from user
  vibeInput   String?

  // AI-generated spec (markdown)
  specContent String?

  // Relations
  tasks       Task[]
  sandboxes   Sandbox[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([status])
}

model Task {
  id           String     @id @default(cuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title        String
  description  String?
  phase        Int        @default(1)    // Phase number (1, 2, 3...)
  order        Int        @default(0)    // Order within phase

  status       TaskStatus @default(PENDING)

  // Dependencies (array of task IDs that must complete first)
  dependencies String[]   @default([])

  // GitHub PR
  prUrl        String?
  prNumber     Int?

  // Execution logs (stored as JSON array of log entries)
  logs         Json?

  // Retry tracking
  attempts     Int        @default(0)
  maxAttempts  Int        @default(3)

  // Current sandbox running this task
  sandbox      Sandbox?

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([projectId, phase, order])
}

model Sandbox {
  id          String        @id @default(cuid())
  projectId   String
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Daytona workspace ID
  daytonaId   String        @unique

  status      SandboxStatus @default(CREATING)

  // Currently assigned task (optional - preview sandboxes may not have a task)
  taskId      String?       @unique
  task        Task?         @relation(fields: [taskId], references: [id], onDelete: SetNull)

  // Sandbox metadata
  snapshotId  String?       // Which template snapshot was used
  publicUrl   String?       // Daytona proxy URL for preview

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([projectId])
  @@index([status])
}
